<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Login to Jira</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="login-style.css">
</head>
<body>
  <div class="login-wrapper">
    <div class="login-card">
      <h1>Connect Jira</h1>
      <p id="msg">Checking Jira connection…</p>

      <button
        class="btn"
        id="btnLogin"
        style="background-color: #0747A6; color: #fff; font-weight: bold;"
      >
        <img
          src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/jira.svg"
          alt="Jira"
          style="width: 18px; height: 18px; vertical-align: middle; margin-right: 6px; filter: invert(1);"
        >
        Login with Jira
      </button>
    </div>
  </div>

  <script>
    const API_BASE = `${location.protocol}//${location.hostname}:8000`;

    async function run() {
      const params = new URLSearchParams(location.search);
      const err = params.get("error");
      if (err) document.getElementById("msg").textContent = "Login error: " + err;

      try {
        const res = await fetch(`${API_BASE}/oauth/atlassian/status`);
        const j = await res.json();

        if (j.connected) {
          document.getElementById("msg").textContent = "Connected ✅ Redirecting…";
          sleep(1000).then(() =>
          location.href = "/");
          return;
        }

        document.getElementById("msg").textContent = "";
        const btn = document.getElementById("btnLogin");
        btn.style.display = "";
        btn.onclick = () => location.href = `${API_BASE}/oauth/atlassian/start`;
      } catch (e) {
        document.getElementById("msg").textContent = "Could not check status.";
        const btn = document.getElementById("btnLogin");
        btn.style.display = "";
        btn.onclick = () => location.href = `${API_BASE}/oauth/atlassian/start`;
      }
    }

    run();
  </script>
</body>
</html>
